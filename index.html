<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Clover — Health & Environment Dashboard</title>
        <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    </head>
    <body
        class="bg-gradient-to-b from-green-50 to-green-100 min-h-screen flex flex-col items-center justify-center"
    >
        <header class="text-center mb-6">
            <h1 class="text-3xl font-semibold text-green-700 tracking-tight">
                Clover Graphical Analysis
            </h1>
            <p class="text-gray-600 text-sm max-w-md mx-auto mt-1">
                Real-time environment & body metrics visualized by
                <span class="text-green-700 font-medium">Clover Health Bot</span
                >.
            </p>
        </header>
        <div class="flex flex-wrap gap-6 justify-center items-start">
            <div
                class="bg-white shadow-md rounded-2xl p-6 flex flex-col items-center justify-center w-72"
            >
                <h2 class="text-lg font-semibold text-green-700 mb-1">
                    Air Quality Index
                </h2>
                <p class="text-gray-500 text-xs mb-4">Atmospheric reading</p>
                <canvas id="aqiChart" width="230" height="230"></canvas>
            </div>
            <div
                class="bg-white shadow-md rounded-2xl p-6 flex flex-col items-center justify-center w-72"
            >
                <h2 class="text-lg font-semibold text-sky-700 mb-1">
                    Ambient Temperature
                </h2>
                <p class="text-gray-500 text-xs mb-4">Environmental reading</p>
                <canvas id="tempChart" width="230" height="230"></canvas>
            </div>
            <div
                class="bg-white shadow-md rounded-2xl p-6 flex flex-col items-center justify-center w-72"
            >
                <h2 class="text-lg font-semibold text-rose-700 mb-1">
                    Body Temperature
                </h2>
                <p class="text-gray-500 text-xs mb-4">Physiological reading</p>
                <canvas id="bodyChart" width="230" height="230"></canvas>
            </div>
            <div
                class="bg-white shadow-md rounded-2xl p-6 flex flex-col items-center justify-center w-72"
            >
                <h2 class="text-lg font-semibold text-blue-700 mb-1">
                    Humidity
                </h2>
                <p class="text-gray-500 text-xs mb-4">
                    Relative humidity level
                </p>
                <canvas id="humChart" width="230" height="230"></canvas>
            </div>
        </div>

        <script>
            const API_URL = "http://<raspi-ip>:8000/api/sensors"; // put your pi's ip address here
            let charts = {
                aqi: null,
                temp: null,
                body: null,
                hum: null,
            };

            const AQI_COLORS = [
                "rgb(76,175,80)",
                "rgb(255,235,59)",
                "rgb(255,152,0)",
                "rgb(244,67,54)",
                "rgb(156,39,176)",
                "rgb(126,0,35)",
            ];
            const AQI_LEVELS = [
                { max: 50, label: "Good" },
                { max: 100, label: "Moderate" },
                { max: 200, label: "Unhealthy (Sensitive)" },
                { max: 300, label: "Unhealthy" },
                { max: 400, label: "Very Unhealthy" },
                { max: 600, label: "Hazardous" },
            ];
            const getAqiColor = (v) =>
                v <= 50
                    ? AQI_COLORS[0]
                    : v <= 100
                      ? AQI_COLORS[1]
                      : v <= 200
                        ? AQI_COLORS[2]
                        : v <= 300
                          ? AQI_COLORS[3]
                          : v <= 400
                            ? AQI_COLORS[4]
                            : AQI_COLORS[5];
            const getAqiStatus = (v) =>
                AQI_LEVELS.find((l) => v <= l.max)?.label || "Unknown";
            function createGauge(
                canvasId,
                value,
                maxValue,
                colorFunc,
                labelFunc,
                unit = "",
                chartKey,
            ) {
                if (charts[chartKey]) {
                    charts[chartKey].destroy();
                }

                const chart = new Chart(document.getElementById(canvasId), {
                    type: "doughnut",
                    data: {
                        datasets: [
                            {
                                data: [value, maxValue - value],
                                backgroundColor: [colorFunc(value), "#eaeaea"],
                                borderWidth: 0,
                                cutout: "75%",
                            },
                        ],
                    },
                    options: {
                        plugins: {
                            tooltip: { enabled: false },
                            legend: { display: false },
                            title: { display: false },
                        },
                        circumference: 180,
                        rotation: -90,
                    },
                    plugins: [
                        {
                            id: `${canvasId}-text`,
                            afterDraw(chart) {
                                const { ctx, chartArea } = chart;
                                const { width, height } = chartArea;
                                const v = value;
                                ctx.save();
                                ctx.font = "bold 26px Inter";
                                ctx.fillStyle = "#333";
                                ctx.textAlign = "center";
                                ctx.fillText(
                                    `${v}${unit}`,
                                    width / 2,
                                    height / 1.35,
                                );
                                ctx.font = "14px Inter";
                                ctx.fillStyle = colorFunc(v);
                                ctx.fillText(
                                    labelFunc(v),
                                    width / 2,
                                    height / 1.15,
                                );
                                ctx.restore();
                            },
                        },
                    ],
                });

                charts[chartKey] = chart;
                return chart;
            }

            const getTempColor = (t) =>
                t <= 0
                    ? "rgb(33,150,243)"
                    : t <= 25
                      ? "rgb(76,175,80)"
                      : t <= 40
                        ? "rgb(255,152,0)"
                        : "rgb(244,67,54)";
            const getTempStatus = (t) =>
                t <= 0 ? "Cold" : t <= 25 ? "Mild" : t <= 40 ? "Warm" : "Hot";

            const getBodyColor = (t) =>
                t < 36
                    ? "rgb(33,150,243)"
                    : t < 37.5
                      ? "rgb(76,175,80)"
                      : t < 39
                        ? "rgb(255,152,0)"
                        : "rgb(244,67,54)";
            const getBodyStatus = (t) =>
                t < 36
                    ? "Hypothermic"
                    : t < 37.5
                      ? "Normal"
                      : t < 39
                        ? "Fever"
                        : "High Fever";

            const getHumColor = (h) =>
                h < 30
                    ? "rgb(33,150,243)"
                    : h < 60
                      ? "rgb(76,175,80)"
                      : h < 80
                        ? "rgb(255,152,0)"
                        : "rgb(244,67,54)";
            const getHumStatus = (h) =>
                h < 30
                    ? "Dry"
                    : h < 60
                      ? "Comfort"
                      : h < 80
                        ? "Humid"
                        : "Very Humid";
            async function loadSensorData() {
                try {
                    const res = await fetch(API_URL);
                    const data = await res.json();

                    const AQI = data.AIRQUALITY || 0;
                    const TEMP = data.TEMP || 0;
                    const BODYTEMP = data.BODYTEMP || 0;
                    const HUM = data.HUMIDITY || 0;

                    createGauge(
                        "aqiChart",
                        AQI,
                        600,
                        getAqiColor,
                        getAqiStatus,
                        "",
                        "aqi",
                    );
                    createGauge(
                        "tempChart",
                        TEMP,
                        50,
                        getTempColor,
                        getTempStatus,
                        "°C",
                        "temp",
                    );
                    createGauge(
                        "bodyChart",
                        BODYTEMP,
                        41,
                        getBodyColor,
                        getBodyStatus,
                        "°C",
                        "body",
                    );
                    createGauge(
                        "humChart",
                        HUM,
                        100,
                        getHumColor,
                        getHumStatus,
                        "%",
                        "hum",
                    );
                } catch (err) {
                    console.error("Failed to fetch sensor data:", err);
                }
            }
            loadSensorData();
            setInterval(loadSensorData, 5000);
        </script>
    </body>
</html>
